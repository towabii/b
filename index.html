<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>震度チェッカー</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
    }
    #map {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0;
    }
    .overlay {
      position: absolute;
      z-index: 2;
      box-sizing: border-box;
    }
    #title {
      top: 5px; left: 50%; transform: translateX(-50%);
      font-size: 12px;
      z-index: 3;
    }
    #intensity {
      top: 0; left: 0; width: 50%; height: 50%;
      font-size: 28px;
      text-align: center;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: background 0.5s;
    }
    #countdown {
      left: 0; bottom: 0; width: 50%; height: 50%;
      font-size: 20px;
      display: flex; justify-content: center; align-items: center;
      text-align: center;
    }
    #tsunami {
      right: 0; top: 0; width: 50%; height: 50%;
      font-size: 18px;
      display: flex; justify-content: center; align-items: center;
      text-align: center;
    }
    #controls {
      right: 0; bottom: 0; width: 50%; height: 50%;
      display: flex;
      flex-direction: row;
    }
    #buttons, #info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 12px;
    }
    button {
      margin: 5px;
      font-size: 14px;
    }
    .background {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1;
      background-color: black;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="background"></div>

  <div id="title" class="overlay">震度チェッカー</div>

  <div id="intensity" class="overlay">
    <div style="font-size: 10px;">震度</div>
    <div id="shindo">0</div>
  </div>
  <div id="countdown" class="overlay">到達まで - 秒</div>
  <div id="tsunami" class="overlay">発表なし</div>

  <div id="controls" class="overlay">
    <div id="buttons">
      <button onclick="startTest()">テスト</button>
      <button onclick="requestSensorPermission()">センサー許可</button>
    </div>
    <div id="info">
      <div id="area">--</div>
      <div id="magnitude">--</div>
    </div>
  </div>

  <audio id="alert" src="oto.mp3"></audio>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script>
    let map = L.map('map').setView([26.2124, 127.6809], 8);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    let marker;
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      marker = L.marker([latitude, longitude]).addTo(map);
      map.setView([latitude, longitude], 9);
    });

    let shakeData = [];
    let shakeStart = null;
    let currentShindo = 0;
    let colorByShindo = shindo => {
      if (shindo < 1) return 'black';
      if (shindo < 4) return 'green';
      if (shindo < 5) return 'yellow';
      if (shindo < 7) return 'red';
      return 'purple';
    };

    if (window.DeviceMotionEvent) {
      window.addEventListener("devicemotion", e => {
        const acc = e.accelerationIncludingGravity;
        const g = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
        const gal = Math.round((g - 9.8) * 100);

        const now = Date.now();
        shakeData.push({ time: now, gal });
        shakeData = shakeData.filter(d => now - d.time <= 3000);

        const avg = shakeData.reduce((sum, d) => sum + Math.abs(d.gal), 0) / shakeData.length;
        let shindo = 0;
        if (avg > 20) shindo = 1;
        if (avg > 50) shindo = 3;
        if (avg > 100) shindo = 5;
        if (avg > 150) shindo = 6;
        if (avg > 200) shindo = 7;

        if (shindo !== currentShindo) {
          currentShindo = shindo;
          document.getElementById("shindo").textContent = shindo;
          document.getElementById("intensity").style.background = colorByShindo(shindo);
          if (shindo >= 3) document.getElementById("alert").play();
        }
      });
    }

    function requestSensorPermission() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission();
      }
    }

    function startTest() {
      document.getElementById("shindo").textContent = "5-";
      document.getElementById("intensity").style.background = colorByShindo(5);
      document.getElementById("area").textContent = "沖縄県那覇市";
      document.getElementById("magnitude").textContent = "M6.8";
      document.getElementById("tsunami").textContent = "津波の心配なし";
      let countdown = 10;
      const interval = setInterval(() => {
        document.getElementById("countdown").textContent = `到達まで ${countdown} 秒`;
        countdown--;
        if (countdown < 0) clearInterval(interval);
      }, 1000);

      // 地震→震源→現在地へのズーム演出（疑似）
      let testLat = 25.5, testLng = 127.2;
      L.circle([testLat, testLng], { radius: 30000, color: 'blue' }).addTo(map);
      map.setView([testLat, testLng], 7);
      setTimeout(() => map.setView(marker.getLatLng(), 9), 3000);
    }
  </script>
</body>
</html>
