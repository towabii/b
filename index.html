<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>震度チェッカー</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      flex-direction: column;
    }
    #top-bar {
      text-align: center;
      font-size: 16px;
      background-color: #1d3557;
      color: white;
      padding: 10px 0;
      width: 100%;
    }
    #main-content {
      display: flex;
      flex: 1;
      flex-direction: row;
      overflow: hidden;
    }
    #left-panel {
      width: 35%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #f1f1f1;
      text-align: center;
    }
    #right-panel {
      width: 65%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #intensity {
      font-size: 150px;
      font-weight: bold;
      margin-top: 10px;
      width: 100%;
      text-align: center;
      color: white;
    }
    #earthquake-info, #time-info {
      font-size: 18px;
      margin-top: 20px;
    }
    #warning {
      font-size: 24px;
      color: red;
      display: none;
      margin-top: 20px;
    }
    #map {
      height: 300px;
      width: 100%;
      margin-top: 20px;
    }
    #tsunami-info {
      font-size: 16px;
      margin-top: 20px;
    }
    #seconds {
      font-size: 32px;
      font-weight: bold;
      margin-top: 20px;
    }
    #permission-button {
      padding: 12px 24px;
      font-size: 18px;
      background-color: #1d3557;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 30px;
    }
    #test-button {
      padding: 12px 24px;
      font-size: 18px;
      background-color: #ff9900;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }

    /* 横向きレイアウト */
    @media (orientation: landscape) {
      #main-content {
        flex-direction: row;
      }
      #left-panel {
        width: 35%;
      }
      #right-panel {
        width: 65%;
      }
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="top-bar">震度チェッカー</div>
  <div id="main-content">
    <div id="left-panel">
      <div id="intensity">震度 0</div>
      <div id="earthquake-info">地震情報</div>
      <div id="map"></div>
    </div>
    <div id="right-panel">
      <div id="time-info">P波到達まで: 0秒<br>S波到達まで: 0秒</div>
      <div id="seconds">残り時間: 0秒</div>
      <div id="tsunami-info">津波予測情報: なし</div>
      <button id="permission-button">センサーを許可</button>
      <button id="test-button">テスト</button>
    </div>
  </div>

  <script>
    let userLat, userLon;
    let lastShakeValue = 0;
    let shakeCounter = 0;
    let shakeHistory = [];
    let earthquakeLocationLat, earthquakeLocationLon;
    const shakeThreshold = 1.5; // 揺れのしきい値（gal）
    const shakeDurationThreshold = 3; // 揺れが続く時間（秒）
    const shakeColorThreshold = 5; // 揺れの色のタイミング（秒）
    const colors = {
      0: "green",  // 震度0
      1: "green",  // 震度1
      2: "green",  // 震度2
      3: "yellow", // 震度3
      4: "yellow", // 震度4
      5: "red",    // 震度5
      6: "red",    // 震度6
      7: "purple"  // 震度7
    };

    // 位置情報取得
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;
          updateMap(userLat, userLon); // 現在地の地図更新
        });
      }
    }

    // 地震情報の取得
    function fetchEarthquakeInfo() {
      fetch('https://api.p2pquake.net/v1/quake/now.json')
        .then(response => response.json())
        .then(data => {
          const earthquake = data.results[0];
          earthquakeLocationLat = earthquake.lat;
          earthquakeLocationLon = earthquake.lon;

          const earthquakeInfo = `
            震源地: ${earthquake.origin} <br>
            発生時刻: ${new Date(earthquake.time * 1000).toLocaleString()}
          `;
          document.getElementById('earthquake-info').innerHTML = earthquakeInfo;

          updateMap(earthquakeLocationLat, earthquakeLocationLon); // 地震の発生地点を地図に表示
          setTimeout(() => updateMap(userLat, userLon), 2000); // 現在地の表示
        })
        .catch(error => console.error('地震情報の取得エラー:', error));
    }

    // 地図表示
    function updateMap(lat, lon) {
      const map = L.map('map').setView([lat, lon], 12);

      L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.gsi.go.jp/kiban/index.html">国土地理院</a>',
        maxZoom: 18
      }).addTo(map);

      L.marker([lat, lon]).addTo(map)
        .bindPopup(`<b>場所:</b> ${lat}, ${lon}`)
        .openPopup();
    }

    // 揺れを検出
    document.getElementById('permission-button').addEventListener('click', function () {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(response => {
          if (response === 'granted') {
            startDetecting();
            this.style.display = 'none';
          } else {
            alert("センサー使用が許可されませんでした。");
          }
        }).catch(console.error);
      } else {
        startDetecting();
        this.style.display = 'none';
      }
    });

    // 揺れを計測する
    function startDetecting() {
      window.addEventListener('devicemotion', function (event) {
        const acc = event.acceleration;
        if (!acc) return;

        const x = acc.x || 0;
        const y = acc.y || 0;
        const z = acc.z || 0;

        const value = Math.sqrt(x * x + y * y + z * z);
        const gal = value * 100;

        // 揺れの強さ（震度）の計算
        const intensity = toIntensity(gal);
        updateIntensity(intensity);

        // 震度の色変更
        document.getElementById('intensity').style.color = colors[intensity];

        // 3秒間同じ揺れを続けた場合に震度表示
        if (Math.abs(gal - lastShakeValue) < shakeThreshold) {
          shakeCounter++;
        } else {
          shakeCounter = 0;
        }

        if (shakeCounter >= shakeDurationThreshold) {
          updateIntensity(intensity); // 震度の更新
        } else {
          document.getElementById('intensity').textContent = "震度 0";
        }

        lastShakeValue = gal;
      });
    }

    // 震度を計算
    function toIntensity(gal) {
      if (gal < 2.5) return 0;
      if (gal < 8) return 1;
      if (gal < 25) return 2;
      if (gal < 80) return 3;
      if (gal < 250) return 4;
      if (gal < 400) return "5-";
      if (gal < 550) return "5+";
      if (gal < 700) return "6-";
      if (gal < 850) return "6+";
      return 7;
    }

    // 震度の更新
    function updateIntensity(intensity) {
      document.getElementById('intensity').textContent = `震度 ${intensity}`;
    }

    // テスト用の地震情報
    document.getElementById('test-button').addEventListener('click', function() {
      earthquakeLocationLat = 24.0;  // 沖縄
      earthquakeLocationLon = 124.0; // 琉球トラフ

      // テスト用のデータ
      document.getElementById('earthquake-info').innerHTML = `
        震源地: 沖縄・琉球トラフ付近 <br>
        発生時刻: ${new Date().toLocaleString()}
      `;

      // 地図に地震地点を表示
      updateMap(earthquakeLocationLat, earthquakeLocationLon);

      // 予測震度、津波予測表示
      document.getElementById('tsunami-info').textContent = "津波予測: なし";
      document.getElementById('time-info').innerHTML = `P波到達まで: 5秒<br>S波到達まで: 10秒`;
      document.getElementById('seconds').textContent = "残り時間: 10秒";
    });

    // ページ読み込み時に位置情報を取得
    getUserLocation();
    fetchEarthquakeInfo();
  </script>
</body>
</html>
