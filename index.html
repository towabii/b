<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>震度チェッカー</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #000;
      color: #fff;
      display: flex;
      flex-direction: row;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    .section {
      box-sizing: border-box;
      padding: 0.5em;
    }
    .left, .right {
      width: 50%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .top-left, .top-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      text-align: center;
    }
    .bottom-left {
      flex: 1;
    }
    .bottom-right {
      flex: 1;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding: 0.5em;
    }
    .shindo-current { font-size: 3rem; }
    .shindo-predict { font-size: 2rem; color: #ccc; }
    .countdown { font-size: 2rem; }
    .tsunami { font-size: 1.5rem; }
    .btn { padding: 1em; margin: 0.5em; font-size: 1rem; }
    .info { text-align: right; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div class="left section">
    <div class="top-left">
      <div class="shindo-current" id="shindoCurrent">震度 0</div>
      <div class="shindo-predict" id="shindoPredict">予測震度: -</div>
    </div>
    <div class="bottom-left">
      <div id="map"></div>
    </div>
  </div>
  <div class="right section">
    <div class="top-right">
      <div class="countdown" id="countdown">P波まで: -- 秒<br>S波まで: -- 秒</div>
      <div class="tsunami" id="tsunamiInfo">津波の心配はありません</div>
    </div>
    <div class="bottom-right">
      <div>
        <button class="btn" onclick="startTest()">テスト</button>
        <button class="btn" onclick="requestSensorPermission()">センサー許可</button>
      </div>
      <div class="info" id="earthquakeInfo">震源地: -<br>マグニチュード: -</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.js"></script>
  <script>
    let currentShindo = 0;
    let stableDuration = 0;
    let lastAccel = 0;
    let testMode = false;
    let shaking = false;
    let shakingTimer;
    let lastUpdateTime = 0;
    let map, userLat = 26.5, userLng = 127.9;
    let epicenter = { lat: 26.5, lng: 127.9 };
    let waveInterval;

    function updateShindo(gal) {
      const shindoScale = [0, 1, 2, 3, 4, 5, 5.5, 6, 6.5, 7];
      const galScale = [0, 5, 20, 80, 250, 400, 800, 1120, 1400, 1600];
      let shindo = 0;
      for (let i = 0; i < galScale.length; i++) {
        if (gal >= galScale[i]) shindo = shindoScale[i];
      }
      return shindo;
    }

    function requestSensorPermission() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(response => {
          if (response === 'granted') {
            window.addEventListener('devicemotion', handleMotion);
          }
        });
      } else {
        window.addEventListener('devicemotion', handleMotion);
      }
    }

    function handleMotion(event) {
      const acc = event.accelerationIncludingGravity;
      const gal = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z) * 100;
      const delta = Math.abs(gal - lastAccel);
      lastAccel = gal;

      if (delta > 10) {
        if (!shaking) {
          shaking = true;
          stableDuration = 0;
        }
        clearTimeout(shakingTimer);
        shakingTimer = setTimeout(() => {
          shaking = false;
          stableDuration = 0;
        }, 3000);
        stableDuration += 0.1;
      }

      if (shaking && stableDuration >= 3) {
        const now = Date.now();
        if (now - lastUpdateTime >= 1000) {
          const shindo = updateShindo(gal);
          currentShindo = shindo;
          document.getElementById('shindoCurrent').textContent = `震度 ${shindo}`;
          updateColor(shindo);
          lastUpdateTime = now;
        }
      }
    }

    function updateColor(shindo) {
      let color = '#000';
      if (shindo >= 7) color = 'purple';
      else if (shindo >= 6) color = 'red';
      else if (shindo >= 4) color = 'yellow';
      else if (shindo >= 1) color = 'green';
      document.body.style.backgroundColor = color;
    }

    function startTest() {
      testMode = true;
      epicenter = { lat: 26.5, lng: 127.9 };
      document.getElementById('shindoPredict').textContent = '予測震度: 5-';
      document.getElementById('earthquakeInfo').innerHTML = '震源地: 琉球トラフ<br>マグニチュード: 7.8';
      document.getElementById('tsunamiInfo').textContent = '津波の恐れがあります';
      calculateWaveArrival();
      setTimeout(() => {
        document.getElementById('shindoCurrent').textContent = '震度 5-';
        updateColor(5.5);
      }, 15000);
    }

    function calculateWaveArrival() {
      const R = 6371;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(epicenter.lat - userLat);
      const dLng = toRad(epicenter.lng - userLng);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(userLat)) * Math.cos(toRad(epicenter.lat)) * Math.sin(dLng / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;

      let p = distance / 6.0;
      let s = distance / 3.5;

      if (waveInterval) clearInterval(waveInterval);
      waveInterval = setInterval(() => {
        p -= 0.1;
        s -= 0.1;
        document.getElementById('countdown').innerHTML = `P波まで: ${Math.max(p, 0).toFixed(1)} 秒<br>S波まで: ${Math.max(s, 0).toFixed(1)} 秒`;
        if (p <= 0 && s <= 0) {
          clearInterval(waveInterval);
        }
      }, 100);
    }

    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      initMap();
    });

    function initMap() {
      map = L.map('map').setView([userLat, userLng], 8);
      L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "&copy; <a href='https://www.gsi.go.jp/'>国土地理院</a>"
      }).addTo(map);
      L.marker([epicenter.lat, epicenter.lng]).addTo(map).bindPopup("震源地").openPopup();
      L.circle([epicenter.lat, epicenter.lng], { radius: 1000, color: 'red' }).addTo(map);
    }
  </script>
</body>
</html>
